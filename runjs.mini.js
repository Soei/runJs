/**
 * 模块加载器
 * @autor alwbg@163.com | soei
 * @Date 2015/4/23
 * @update 2016/1/8 修改低版本的加载问题.
 * @update 2016/4/12 修改获取模块ID问题 短ID和长ID的对称性
 * @update 2016/4/15 整理映射表
 *         1. 修改了获取模版ID的相关逻辑
 *         2. 修改了加载中的模块对应的映射表
 *         3. 修改计算模版ID 计算及存的逻辑, 只做计算不存储
 *         4. 修改只删除AMD模块执行创建的费对象问题
 * @update 2017/6/23 新增对HTML内的runJs代码块的支持
 *         <!--其中先执行代码块内的代码,再执行main模块的代码-->
 *         <script src="runjs.js" main="main" >
 *         		//module-name = "__runjs.inner__"
 *         		var $ = require( 'query' );
 *         		$( 'test' ).appendTo( 'body' );
 *         		//exports 为方法块内部对象
 *         		exports.run = function(){
 *         		}
 *         		//为main模块传递参数
 *         		return {
 *         			log : function(){
 *         			}
 *         		}
 *         </script>
 * 目前支持的
 * - firefox2.0以上(低版本由于不能安装没办验证)
 * - webkit 534版本及以上, 低版本未验证
 * - IE5以上
 * - opera
 * creation-time : 2017-06-24 20:08:10 PM
 */
!function(t){"use strict";function e(t){return document.createElement(t)}function r(t,e){return(e||document).getElementsByTagName(t)}function n(t,e){this.id=t,this.exports=e,K[t]=e}function i(t,e){this.id=t,this.module=e,this.moduleID=e.id,this.wake()}function o(t,e){new n(t,e),e.id=t,new i("declare",e).done()}function a(t){if("string"==typeof t){var e=new RegExp("^\\[object "+t+"\\]$");return function(t){return e.test(O.toString.call(t))}}return function(e){return e instanceof t}}function s(){if(document.currentScript)return document.currentScript;var t,e,n,i,o=r("script");try{___I__Will__Error_____()}catch(a){i=a,t=a.stack}if(t&&(t=t.replace(G,D),n=Q.getScriptByUri(t,o)))return n;for(e=0;n=o[e++];)if("interactive"===n.readyState)return n;return Q.getScriptByUri(Q.currentLoad||i.sourceURL,o)}function u(t,e,r,n){var i,o,a,s,u;for(u=N.call(arguments),o=u.pop(),u.push(o),/false|true/gi.test(o)||u.push(!1),o=u.pop(),a=u.pop();s=u.shift();)for(i in a)!o&&s.hasOwnProperty&&s.hasOwnProperty(i)||(s[i]=a[i])}function c(t,e,r){r=r||this;for(var n=t.split("."),i=0;t=n[i++];)if(t in r){if(r=r[t],lt(r)){I("%c"+t+" 's type not Object! need Object {} ","color:red");break}}else r=r[t]={};return u(r,e),r}function l(t,e,r){ot(e)&&Z.factory[at(t)?M:k].call(r,t,e)}function f(){}function p(t,r,n){n||(n=t);var i=e(t.type);l(t.attr,function(t,e){this.setAttribute(t,e)},i),this.argument=[i,r,n],this.onload(t.isScript).onerror(i),rt.appendChild(i),I("%c正在加载模块 -> "+t.uri,"color:#e0e")}function d(t){t=Z.toRealMI(t);var e;if(e=Z.isInModules(t))return e;if(e=Z.isInStorage(t)){var r,i=new n(t,{}),o=e.data();return I("%c正在创建模块 : "+t,"color:blue"),r=o.length?Z.factory.require(e):o.factory.apply(e,[h,i.exports,i,t]),ot(r)?i.exports=r:u(i.exports,r),i.rebulid(),e.done(),i.exports}}function h(t,e){return ft(t)&&void 0===e?d(t):(ot(t)&&(e=t,t=[]),h.async(t,e))}function y(t,e,r){var o,a=st(this)?this+b:Z.pickMI(),s=0;if(it(t)||it(e)&&++s)return s||(e=t,t=a),t=Z.moduleId(t,a),new i(T,new n(t,e)).done();var u=pt.checkByType(U,[t,e,r],[a,[],function(){}]);t=u[0],e=u[1],r=u[2],r.cmd=!e.length;var c=Z.moduleId(t,a);(o=Z.isInStorage(c))||(o=new i(T,{id:c,deps:e,factory:r,length:e.length,alias:t})),o.isInActive()&&o.run()}function g(t){m(t||W,function(){for(var t,e=[],r={};t=z.pop();)if(ct(t)&&!t.isDone()&&t.isInStorage()&&!(t.module.factory in r))if(r[t.module.factory]=0,t.isReady())pt.runFx(Z.factory[t.id],t),t.done();else if(e.push(t),t.id==T)break;$.apply(z,e)})}function m(e,r){if(!Q.isSimplyLoad){if(!e.length)return I("%c依赖列队加载完毕","color:#3e3"),pt.runFx(r);var n,i=e.shift();if(I("%c准备加载模块 -> "+i,"color:#666"),n=Z.isInStorage(i))n.run();else{if(Z.isInLoading(i))return I("%c已在加载列表 -> "+i,"color:#e06");var o=Z.uri.get(i);Q.currentLoad=o.uri,H&&(Q.isSimplyLoad=!0),new p(o,function(e){I("该标签 : ",e.type,".sheet = ",!!this.argument[0].sheet," : ",e.uri,"color:red"),Q.isSimplyLoad=!1;var r=e.uri;if(r in tt){var n=tt[r]||[],i=n.exports;i&&y.call(r,n.deps,function(){return t[i]})}!Z.isInStorage(r)&&y.call(r,{}),g()})}m(e,r)}}function v(){Y&&h.async(Y)}function I(){t.DEBUG&&E.apply(t,L.slice.call(arguments))}function S(){var t=N.call(arguments).join("");yt||(yt=document.createElement("div"),yt.id="debugBox",document.body.appendChild(yt)),gt||(gt=/(?:^\%c|color\:(.*)$)/g);var e=document.createElement("div"),r=t.replace(gt,b);r!=t&&(e.style.color=RegExp.$1),e.innerHTML=r,yt.appendChild(e),e.setAttribute("debug","true"),yt.scrollTop+=e.offsetHeight+10}function E(){try{var t=Array.apply(null,arguments);console.log.apply(console,t)}catch(e){try{S(N.call(arguments).join("\r\n\r\n"))}catch(e){}}}var R,x="deps-name",T="define",_="require",A="main",k="object",M="array",b="",D="$1",w="$1$2",L=[],O=Object.prototype,$=L.push,N=L.slice,U=["String",Array,Function],j=location.pathname.replace(/[^\/]*$/,b),F=navigator.userAgent,q=F.replace(/.*webkit\/([\d]+).*/i,D)<=534,B=F.replace(/.*firefox\/([\d\.]+).*/i,D)<9;I(F);var H=q||B,C=/^function\s*\(\s*([^\),\s]+)/,P="\\s*\\(\\s*(?:'([^']+)'|\"([^\"]+)\")\\s*\\)",G=/[\D\d]*(?:at|@).*((?:http(?:s|)|file)\:(?:\:(?!\d)|[^\:])*)(?:\:\d*){1,}(?:\)|\r|\n|)$/i,X="#",Q=t._Qma||{},J=Q.v||b,Y=null,z=[],W=[],K={},V={},Z={},tt=Q.depends||{},et={};Z.requireIDs={},u(et,Q.alias),Q.comp=function(t,e){var r=t.getAttribute(x);return e=e.split(X)[0],r==e||e==t.src},Q.tmp={getAttribute:function(){return location.host}},Q.getScriptByUri=function(t,e){for(var r,n=e.length;(r=e[--n])&&(R==r||!this.comp(r,t)););return r||this.tmp},Z.moduleStorage={},Z.toRealMI=function(t){return Z.uri.real(et[t]||t)},Z.isInStorage=function(t){return Z.moduleStorage[this.toRealMI(t)]},Z.isInLoading=function(t){var t=t.realMI(),e=V[t];return!e&&(V[t]=t),e},Z.pickMI=function(){return s().getAttribute(x)},Z.moduleIdRMap={},Z.moduleId=function(t,e){var r=this.moduleIdRMap[t]||(this.moduleIdRMap[t]=new RegExp(t+"$"));return r.test(e)||(e=e+X+t),et[t]=(e||t).realMI()},Z.isInModules=function(t){return K[t]},Z.pull=function(t,e){var r=e.cmd&&C.test(t)?"|"+RegExp.$1:b;return new RegExp("[^a-z](?:"+_+r+")"+P,"ig")},String.prototype.has=function(t){return st(t)&&(t=this.indexOf(t)>-1),ut(t)&&(t=t.test(this)),t},String.prototype.realMI=function(){return Z.toRealMI(this)};var rt=(r("script"),r("head")[0]);n.prototype.rebulid=function(){return K[this.id]=this.exports,this},u(i.prototype,{active:{},storage:Z.moduleStorage,echo:E,each:l,tools:new f,data:function(){return this.module},wake:function(){return this.storage[this.moduleID]=this,this},stack:function(){return z.push(this),this},remove:function(){return this.id==_&&delete this.storage[this.moduleID],this},space:function(){return delete K[this.moduleID],this.remove()},depend:function(){var t=this.data();return t.alias in tt&&$.apply(t.deps,(tt[t.alias]||{}).deps||[]),ot(t.factory)&&$.apply(t.deps,pt.getDeps(t.factory)),t.deps||[]},isInActive:function(){return this.moduleID in this.active},run:function(){if(this.isDone())return this;var t=this.depend();return l(t,function(t,e){this[e.realMI()]=!0},this.active),I("%c检索模块依赖 -> "+this.moduleID+" : ["+t+"] \r\n","color:#070"),$.apply(W,t),this.stack(),g(),this},done:function(){return this.loaded=!0,this},isDone:function(){return this.loaded},isInStorage:function(){return this.moduleID in this.storage},isReady:function(){for(var t,e=this.data().deps,r=e.length;t=e[--r];)if(!Z.isInStorage(t))return I("%c所依赖的模块["+t+"] [未加载完成]","color:#777"),!1;return!0}});var nt=a("Object"),it=function(t){return t&&nt(t)},ot=a("Function"),at=a("Array"),st=a("String"),ut=a(RegExp),ct=a(i),lt=a("(?:Number|Boolean|Null|String|Undefined)"),ft=(a("(?:Array|String)"),a("(?:(?!Array)|String)"));c("alias",{},Q),c("types",{},Q),c("pick",{},Q),Z.factory={array:function(t,e,r,n){for(r=0,n=t.length;n>r&&!e.call(this,r,t[r],t);r++);},object:function(t,e,r){for(r in t)if(e.call(this,r,t[r],t))break},push:function(t,e,r){return t.push(r)},add:function(t,e,r){t[e]=r}};var pt=new f,dt=c("format.function",{SEP:"{@}",START:"{%}",LEFT:"{",RIGHT:"}",map:{},NUM:1e6,_ONLY_REQUIRE:/(require\s*\([^\),]*,\s*function\s*\([^\)]*\)\s*\{)/,REQUIRE:/(?:(require\s*\([^\),]*,\s*function\s*\([^\)]*\)\s*\{)|(\{)|(\}))/g,REPLACE:function(t){return this.map[t]||(this.map[t]=new RegExp("\\"+this.START+t+"(?:(?!\\"+this.SEP+t+").|\\n)*\\"+this.SEP+t))}},Z);if(u(f.prototype,{ANNOTATION_REG:/(?:(\/\*+(?:[^*]|\*[^\/])*\*\/))|(?:([^\/'":])\/\/.*$)[\r\n]*/gm,runFx:function(t,e){var r=N.call(arguments),n=r.shift();return n instanceof Function?n.apply(this,r):void 0},getDeps:function(t){var e=t.toString();e=e.replace(this.ANNOTATION_REG,b),dt._ONLY_REQUIRE.test(e)&&(e=this.removeAsyncRequire(e));var r={mark:Z.pull(e,t),pick:[],map:Z.requireIDs};return l(e.match(r.mark)||[],function(t,e){e=e.replace(this.mark,w),e in this.map||(this.map[e]=!0,this.pick.push(e))},r),r.pick},removeAsyncRequire:function(t){var e=dt.LEFT,r=dt.RIGHT,n=dt.SEP,i=dt.START,o=!1,a=0,s=dt.NUM;for(t=t.replace(dt.REQUIRE,function(t,u){return u?(s=1,a++,o=!0,i):o&&(t==e&&s++,t==r&&s--,0==s)?(o=!1,s=dt.NUM,n):b});-1!=t.indexOf(i)&&a--;)t=t.replace(dt.REPLACE(b),b);return t},checkByType:function(t,e,r){if(!at(e))return i;r||(r=[]);for(var n,i=[],o=0,s=t.length;(n=e.shift())||s>o;)a(t[o])(n)?i.push(n):(n&&e.unshift(n),i.push(r[o])),o++;return i},pick:function(t,e,r){if(!at(e))return t;var n,i=r||{},o=Z.factory[at(r)?"push":"add"];return l(e,function(e,r){n=r in t,n&&this.fx(this.box,r,t[r])},{box:i,fx:o}),i},toArray:function(t){return N.call(t)},merge:u}),R=s(),pt.config={JS:".js",CSS:".css",".js":"script",".css":"link",data:{link:{type:"text/css",rel:"stylesheet"}},src:{link:"href",script:"src"},info:function(t){return"%cError: at ["+t+"] Modules do not exist or load timed out!"}},u(p.prototype,{onload:function(t){return this[H&&!t?"load":"moduleLoad"].apply(this,this.argument),this},onerror:function(t){var e=this;return t.onerror=function(){e.task&&e.task.space(),I(pt.config.info(e.attr.src),"color:red")},this},load:function(t,e,r){var n=0,i=this;I("进入低版本样式加载模式 > ",t.href,"color:#9bd807");var o=100,a=15e3;!function s(){return t.sheet||n>a?e.call(i,r):(n+=o,void setTimeout(s,o))}()},moduleLoad:"onreadystatechange"in R?function(t,e,r){var n=this;t.onreadystatechange=function(t){/^(?:complete|loaded)$/.test(this.readyState)&&pt.runFx.call(n,e,r)}}:function(t,e,r){var n=this;t.onload=function(t){pt.runFx.call(n,e,r)}}}),h.async=function(t,e){st(t)&&(t=[t.realMI()]);var r=t.length,n=new i(_,{id:st(this)?this:_+ +new Date,deps:t,length:r,factory:e});for(n.async=!!r;r--&&Z.isInModules(t[r]););0>r?Z.factory.require(n):n.run()},h.use=h.async,c("factory",{require:function(t){var e=t.data(),r=e.deps.slice(0,e.length);return l(r,function(t,e){this[t]=d(e)},r),r.unshift(e.factory),pt.runFx.apply(t.remove(),r)}},Z),c("uri",{DOT_EXTNAME:/\.(js(?=$|#))/,HAS_EXT:/(?:(\.(?:css|js))|(.))(\?|\#|$)/,DOT:/(?:[^\/]*\/[^\/]*\.{2}\/|\/\.(?!\.))/,get:function(t){var e=Q.types[t];e||(t=t.split(X)[0]);var r=this.extname(t).toLowerCase(),n=this.path(/^(?:http[s]?|file)\:/.test(t)?t:t.realMI(),r),i={uri:t,type:pt.config[r],attr:{async:!0},suffix:r};return i.isScript=r==pt.config.JS,i.attr[x]=i.uri,i.attr[pt.config.src[i.type]]=n,u(i.attr,pt.config.data[i.type]),i},real:function(t){if(this.DOT.test(t))for(t=j+t;this.DOT.test(t);)t=t.replace(this.DOT,b);return t.replace(this.DOT_EXTNAME,b)},extname:function(t){var e=Z.toRealMI(t),r=Q.types[t];return r||(this.HAS_EXT.test(e),r=RegExp.$1 in pt.config?RegExp.$1:pt.config.JS),I(e,">",this.HAS_EXT.test(e)," : |",r,"|","color:#07afd8"),r},path:function(t,e){var r=/\?|#/.test(t)?"&":"?";return t=t.replace(this.HAS_EXT,"$2"+e+"$3"),t+r+J}},Z),u(t,{define:y,require:h,modules:K},!0),o(_,h),o("_tools__",pt.pick(pt,["runFx","checkByType","pick"])),Y=R.getAttribute(A),R.innerHTML){var ht="__runjs.inner__";y.call(ht,new Function("require","exports","module","__module_name",R.innerHTML)),h(ht,function(){v(),g()})}else v();t.DEBUG=t.DEBUG||!1,t.appendChild=S;var yt,gt}(window);