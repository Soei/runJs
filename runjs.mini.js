/**
 * 模块加载器
 * @autor alwbg@163.com | soei
 *  ------------------------------------
 *  -  https://github.com/alwbg/runJs  -
 *  ------------------------------------
 * @Date 2015/4/23
 * 内部声明名称与文件名称不一致时, 请用alias '[模块短连接]':'[文件路径][#][模块名称]'
 * @update 2016/1/8 修改低版本的加载问题.
 * @update 2016/4/12 修改获取模块ID问题 短ID和长ID的对称性
 * @update 2016/4/15 整理映射表
 *         1. 修改了获取模版ID的相关逻辑
 *         2. 修改了加载中的模块对应的映射表
 *         3. 修改计算模版ID 计算及存的逻辑, 只做计算不存储
 *         4. 修改只删除AMD模块执行创建的费对象问题
 * @update 2017/6/23 新增对HTML内的runJs代码块的支持
 *         <!--其中先执行代码块内的代码,再执行main模块的代码-->
 *         <script src="runjs.js" main="main" >
 *         		//module-name = "__runjs.inner__"
 *         		var $ = require( 'query' );
 *         		$( 'test' ).appendTo( 'body' );
 *         		//exports 为方法块内部对象
 *         		exports.run = function(){
 *         		}
 *         		//为模块间传递参数
 *         		return {
 *         			language : {zh:{},en:{}}
 *         		}
 *         </script>
 * @update 2017/7/5 22:30 修改 _async_require_map._async_fx__ 对ES6 function新语法支持
 * 目前支持的
 * - firefox2.0以上(低版本由于不能安装没办验证)
 * - webkit 534版本及以上, 低版本未验证
 * - IE5以上
 * - opera
 * creation-time : 2018-04-26 12:44:10 PM
 */
!function(t){"use strict";function e(t){return document.createElement(t)}function r(t,e){return(e||document).getElementsByTagName(t)}function n(t,e){this.id=t,this.exports=e,J[t]=e}function i(t,e){this.id=t,this.module=e,this.moduleID=e.id,this.wake()}function o(t,e){new n(t,e),e.id=t,new i("declare",e).done()}function s(t){if("string"==typeof t){var e=new RegExp("^\\[object "+t+"\\]$");return function(t){return e.test(w.toString.call(t))}}return function(e){return e instanceof t}}function u(){if(document.currentScript)return document.currentScript;var t,e,n,i,o=r(k);try{___I__Will__Error_____()}catch(e){i=e,t=e.stack}if(t&&(t=t.replace(U,M),n=H.getScriptByUri(t,o)))return n;for(e=0;n=o[e++];)if("interactive"===n.readyState)return n;return H.getScriptByUri(H.currentLoad||i.sourceURL,o)}function a(t,e,r,n){var i,o,s,u,a;for(o=(a=$.call(arguments)).pop(),a.push(o),/false|true/gi.test(o)||a.push(!1),o=a.pop(),s=a.pop();u=a.shift();)for(i in s)!o&&u.hasOwnProperty&&u.hasOwnProperty(i)||(u[i]=s[i])}function c(t,e,r){r=r||this;for(var n=t.split("."),i=0;t=n[i++];)if(t in r){if(r=r[t],it(r)){_("%c"+t+" 's type not Object! need Object {} ","color:red");break}}else r=r[t]={};return a(r,e),r}function l(t,e,r){Z(e)&&Q.factory[tt(t)?R:T].call(r,t,e)}function f(){}function p(t,r,n){n||(n=t);var i=e(t.type);l(t.attr,function(t,e){this.setAttribute(t,e)},i),this.argument=[i,r,n],this.onload(t.isScript).onerror(i),V.appendChild(i),_("%c正在加载模块 -> "+t.uri,"color:#e0e")}function d(t){t=Q.toRealMI(t);var e;if(e=Q.isInModules(t))return e;if(e=Q.isInStorage(t)){var r,i=new n(t,{}),o=e.data();return _("%c正在创建模块 : "+t,"color:blue"),r=o.length?Q.factory.require(e):o.factory.apply(e,[h,i.exports,i,t]),Z(r)?i.exports=r:a(i.exports,r),i.rebulid(),e.done(),i.exports}}function h(t,e){return st(t)&&void 0===e?d(t):(Z(t)&&(e=t,t=[]),h.async(t,e))}function y(t,e,r){var o,s=et(this)?this+A:Q.pickMI(),u=0;if(ot(t)||ot(e)&&++u)return u||(e=t,t=s),t=Q.moduleId(t,s),new i(E,new n(t,e)).done();var a=ut.checkByType(q,[t,e,r],[s,[],function(){}]);t=a[0],e=a[1],(r=a[2]).cmd=!e.length;var c=Q.moduleId(t,s);(o=Q.isInStorage(c))||(o=new i(E,{id:c,deps:e,factory:r,length:e.length,alias:t})),o.isInActive()&&o.run()}function g(t){m(t||X,function(){for(var t,e=[],r={};t=G.pop();)if(nt(t)&&!t.isDone()&&t.isInStorage()&&!(t.module.factory in r))if(r[t.module.factory]=0,t.isReady())ut.runFx(Q.factory[t.id],t),t.done();else if(e.push(t),t.id==E)break;D.apply(G,e)})}function m(e,r){if(!H.isSimplyLoad){if(!e.length)return _("%c依赖列队加载完毕","color:#3e3"),ut.runFx(r);var n,i=e.shift();if(_("%c准备加载模块 -> "+i,"color:#666"),n=Q.isInStorage(i))n.run();else{if(Q.isInLoading(i))return _("%c已在加载列表 -> "+i,"color:#e06");var o=Q.uri.get(i);H.currentLoad=o.uri,F&&(H.isSimplyLoad=!0),new p(o,function(e){_("该标签 : ",e.type,".sheet = ",!!this.argument[0].sheet," : ",e.uri,"color:red"),H.isSimplyLoad=!1;var r=e.uri;if(r in W){var n=W[r]||[],i=n.exports;i&&y.call(r,n.deps,function(){return t[i]})}!Q.isInStorage(r)&&y.call(r,{}),g()})}m(e,r)}}function v(){P&&h.async(P)}function _(){t.DEBUG&&S.apply(t,b.slice.call(arguments))}function I(){var t=$.call(arguments).join("");ct||((ct=document.createElement("div")).id="debugBox",document.body.appendChild(ct)),lt||(lt=/(?:^\%c|color\:(.*)$)/g);var e=document.createElement("div"),r=t.replace(lt,A);r!=t&&(e.style.color=RegExp.$1),e.innerHTML=r,ct.appendChild(e),e.setAttribute("debug","true"),ct.scrollTop+=e.offsetHeight+10}function S(){try{var t=Array.apply(null,arguments);console.log.apply(console,t)}catch(t){try{I($.call(arguments).join("\r\n\r\n"))}catch(t){}}}var x,E="define",T="object",R="array",A="",k="script",M="$1",b=[],w=Object.prototype,D=b.push,$=b.slice,q=["String",Array,Function],L=location.pathname.replace(/[^\/]*$/,A),O=navigator.userAgent,j=O.replace(/.*webkit\/([\d]+).*/i,M)<=534,N=O.replace(/.*firefox\/([\d\.]+).*/i,M)<9;_(O);var F=j||N,B=/^\w*\(\s*([^\),\s]+)(?:=>)?/,U=/[\D\d]*(?:at|@).*((?:http(?:s|)|file)\:(?:\:(?!\d)|[^\:])*)(?:\:\d*){1,}(?:\)|\r|\n|)$/i,H=t._Qma||{},C=H.v||A,P=null,G=[],X=[],J={},z={},Q={},W=H.depends||{},K={};Q.requireIDs={},a(K,H.alias),H.comp=function(t,e){var r=t.getAttribute("deps-name");return e=e.split("#")[0],r==e||e==t.src},H.tmp={getAttribute:function(){return location.host}},H.getScriptByUri=function(t,e){for(var r,n=e.length;(r=e[--n])&&(x==r||!this.comp(r,t)););return r||this.tmp},Q.moduleStorage={},Q.toRealMI=function(t){return Q.uri.real(K[t]||t)},Q.isInStorage=function(t){return Q.moduleStorage[this.toRealMI(t)]},Q.isInLoading=function(t){var t=t.realMI(),e=z[t];return!e&&(z[t]=t),e},Q.pickMI=function(){return u().getAttribute("deps-name")},Q.moduleIdRMap={},Q.moduleId=function(t,e){return(this.moduleIdRMap[t]||(this.moduleIdRMap[t]=new RegExp(t+"(?:$|\\.js)","i"))).test(e)||(e=e+"#"+t),K[t]=(e||t).realMI()},Q.isInModules=function(t){return J[t]},Q.pull=function(t,e){var r,n=e.cmd&&B.test(t)&&(r=RegExp.$1)&&"require"!=r?"|"+RegExp.$1:A;return new RegExp("[^a-z](?:require"+n+")\\s*\\(\\s*(?:'([^']+)'|\"([^\"]+)\")\\s*\\)","ig")},String.prototype.has=function(t){return et(t)&&(t=this.indexOf(t)>-1),rt(t)&&(t=t.test(this)),t},String.prototype.realMI=function(){return Q.toRealMI(this)};r(k);var V=r("head")[0];n.prototype.rebulid=function(){return J[this.id]=this.exports,this},a(i.prototype,{active:{},storage:Q.moduleStorage,echo:S,each:l,tools:new f,data:function(){return this.module},wake:function(){return this.storage[this.moduleID]=this,this},stack:function(){return G.push(this),this},remove:function(){return"require"==this.id&&delete this.storage[this.moduleID],this},space:function(){return delete J[this.moduleID],this.remove()},depend:function(){var t=this.data();return t.alias in W&&D.apply(t.deps,(W[t.alias]||{}).deps||[]),Z(t.factory)&&D.apply(t.deps,ut.getDeps(t.factory)),t.deps||[]},isInActive:function(){return this.moduleID in this.active},run:function(){if(this.isDone())return this;var t=this.depend();return l(t,function(t,e){this[e.realMI()]=!0},this.active),_("%c检索模块依赖 -> "+this.moduleID+" : ["+t+"] \r\n","color:#070"),D.apply(X,t),this.stack(),g(),this},done:function(){return this.loaded=!0,this},isDone:function(){return this.loaded},isInStorage:function(){return this.moduleID in this.storage},isReady:function(){for(var t,e=this.data().deps,r=e.length;t=e[--r];)if(!Q.isInStorage(t))return _("%c所依赖的模块["+t+"] [未加载完成]","color:#777"),!1;return!0},require:h});var Y=s("Object"),Z=s("Function"),tt=s("Array"),et=s("String"),rt=s(RegExp),nt=s(i),it=s("(?:Number|Boolean|Null|String|Undefined)"),ot=function(t){return t&&Y(t)},st=s("(?:(?!Array)|String)");c("alias",{},H),c("suffixs",{},H),c("pick",{},H),Q.factory={array:function(t,e,r,n){for(r=0,n=t.length>>0;r<n&&!e.call(this,r,t[r],t);r++);},object:function(t,e,r){for(r in t)if(e.call(this,r,t[r],t))break},push:function(t,e,r){return t.push(r)},add:function(t,e,r){t[e]=r}};var ut=new f,at={SEP:"{@}",START:"{%}",LEFT:"{",RIGHT:"}",map:{},NUM:1e6,_has_async_func_:/(?:require|\w+)\s*\([^),]*/,_async_fx__:/(?:((?:require|\w+)\s*\([^),]*,[^(]*\([^)]*\)\s*(?:=>)?\s*\{)|(\{)|(\}))/g,REPLACE:function(t){return this.map[t]||(this.map[t]=new RegExp("\\"+this.START+t+"(?:(?!\\"+this.SEP+t+").|\\n)*\\"+this.SEP+t))}};if(a(f.prototype,{ANNOTATION_REG:/(?:(\/\*+(?:[^*]|\*[^\/])*\*\/))|(?:([^\/'":])\/\/.*$)[\r\n]*/gm,runFx:function(t,e){var r=$.call(arguments),n=r.shift();if(n instanceof Function)return n.apply(this,r)},getDeps:function(t){var e=t.toString();e=e.replace(this.ANNOTATION_REG,A),at._has_async_func_.test(e)&&(e=this.removeAsyncRequire(e));var r={mark:Q.pull(e,t),pick:[],map:Q.requireIDs};return l(e.match(r.mark)||[],function(t,e){(e=e.replace(this.mark,"$1$2"))in this.map||(this.map[e]=!0,this.pick.push(e))},r),r.pick},removeAsyncRequire:function(t){var e=at.LEFT,r=at.RIGHT,n=at.SEP,i=at.START,o=!1,s=0,u=at.NUM;for(t=t.replace(at._async_fx__,function(t,a){return a?(u=1,s++,o=!0,i):o&&(t==e&&u++,t==r&&u--,0==u)?(o=!1,u=at.NUM,n):A});-1!=t.indexOf(i)&&s--;)t=t.replace(at.REPLACE(A),A);return t},checkByType:function(t,e,r){if(!tt(e))return i;r||(r=[]);for(var n,i=[],o=0,u=t.length;(n=e.shift())||o<u;)s(t[o])(n)?i.push(n):(n&&e.unshift(n),i.push(r[o])),o++;return i},pick:function(t,e,r){if(!tt(e))return t;var n,i=r||{};return l(e,function(e,r){(n=r in t)&&this.fx(this.box,r,t[r])},{box:i,fx:Q.factory[tt(r)?"push":"add"]}),i},toArray:function(t){return $.call(t)},merge:a}),x=u(),ut.config={JS:".js",CSS:".css",".js":k,".css":"link",data:{link:{type:"text/css",rel:"stylesheet"}},src:{link:"href",script:"src"},info:function(t){return"%cError: at ["+t+"] Modules do not exist or load timed out!"}},a(p.prototype,{onload:function(t){return this[F&&!t?"load":"moduleLoad"].apply(this,this.argument),this},onerror:function(t){var e=this;return t.onerror=function(){e.task&&e.task.space(),_(ut.config.info(e.attr.src),"color:red")},this},load:function(t,e,r){var n=0,i=this;_("进入低版本样式加载模式 > ",t.href,"color:#9bd807");!function o(){if(t.sheet||n>15e3)return e.call(i,r);n+=100,setTimeout(o,100)}()},moduleLoad:"onreadystatechange"in x?function(t,e,r){var n=this;t.onreadystatechange=function(t){/^(?:complete|loaded)$/.test(this.readyState)&&ut.runFx.call(n,e,r)}}:function(t,e,r){var n=this;t.onload=function(t){ut.runFx.call(n,e,r)}}}),h.async=function(t,e){et(t)&&(t=[t.realMI()]);var r=t.length,n=new i("require",{id:et(this)?this:"require"+ +new Date,deps:t,length:r,factory:e});for(Z(e)&&(e.cmd=!1),n.async=!!r;r--&&Q.isInModules(t[r]););r<0?Q.factory.require(n):n.run()},h.use=h.async,c("factory",{require:function(t){var e=t.data(),r=e.deps.slice(0,e.length);return l(r,function(t,e){this[t]=d(e)},r),r.unshift(e.factory),ut.runFx.apply(t.remove(),r)}},Q),c("uri",{DOT_EXTNAME:/\.(js(?=$|#))/,HAS_EXT:/(?:(\.(?:css|js))|(.))(\?|\#|$)/,DOT:/(?:[^\/]*\/[^\/]*\.{2}\/|\/\.(?!\.))/,get:function(t){H.suffixs[t]||(t=t.split("#")[0]);var e=this.extname(t).toLowerCase(),r=this.path(/^(?:http[s]?|file)\:/.test(t)?t:t.realMI(),e),n={uri:t,type:ut.config[e]||k,attr:{async:!0},suffix:e||A};return n.isScript=n.type==k,n.attr["deps-name"]=n.uri,n.attr[ut.config.src[n.type]]=r,a(n.attr,ut.config.data[n.type]),n},real:function(t){if(this.DOT.test(t))for(t=L+t;this.DOT.test(t);)t=t.replace(this.DOT,A);return t.replace(this.DOT_EXTNAME,A)},extname:function(t){var e=Q.toRealMI(t),r=H.suffixs[t];return void 0===r&&(this.HAS_EXT.test(e),r=RegExp.$1 in ut.config?RegExp.$1:ut.config.JS),_(e,">",this.HAS_EXT.test(e)," : |",r,"|","color:#07afd8"),r},path:function(t,e){var r=/\?|#/.test(t)?"&":"?";return(t=t.replace(this.HAS_EXT,"$2"+e+"$3"))+(C&&r+C)||A}},Q),a(t,{declare:y,$define:y,define:y,require:h,$require:h,modules:J,$modules:J},!1),o("require",h),o("_tools__",ut.pick(ut,["runFx","checkByType","pick"])),y.toString=h.toString=function(){return"function(){[native code]}"},P=x.getAttribute("main"),x.innerHTML){y.call("__runjs.inner__",new Function("require","exports","module","__module_name",x.innerHTML)),h("__runjs.inner__",function(){v(),g()})}else v();t.DEBUG=t.DEBUG||!1,t.appendChild=I;var ct,lt}(window);