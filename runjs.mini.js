/**
 * 模块加载器
 * @autor alwbg@163.com | soei
 *  ------------------------------------
 *  -  https://github.com/alwbg/runJs  -
 *  ------------------------------------
 * @Date 2015/4/23
 * 内部声明名称与文件名称不一致时, 请用alias '[模块短连接]':'[文件路径][#][模块名称]'
 * @update 2016/1/8 修改低版本的加载问题.
 * @update 2016/4/12 修改获取模块ID问题 短ID和长ID的对称性
 * @update 2016/4/15 整理映射表
 *         1. 修改了获取模版ID的相关逻辑
 *         2. 修改了加载中的模块对应的映射表
 *         3. 修改计算模版ID 计算及存的逻辑, 只做计算不存储
 *         4. 修改只删除AMD模块执行创建的费对象问题
 * @update 2017/6/23 新增对HTML内的runJs代码块的支持
 *         <!--其中先执行代码块内的代码,再执行main模块的代码-->
 *         <script src="runjs.js" main="main" >
 *         		//module-name = "__runjs.inner__"
 *         		var $ = require( 'query' );
 *         		$( 'test' ).appendTo( 'body' );
 *         		//exports 为方法块内部对象
 *         		exports.run = function(){
 *         		}
 *         		//为模块间传递参数
 *         		return {
 *         			language : {zh:{},en:{}}
 *         		}
 *         </script>
 * @update 2017/7/5 22:30 修改 _async_require_map._async_fx__ 对ES6 function新语法支持
 * 目前支持的
 * - firefox2.0以上(低版本由于不能安装没办验证)
 * - webkit 534版本及以上, 低版本未验证
 * - IE5以上
 * - opera
 * creation-time : 2019-05-15 11:56:59 AM
 */
!function(a){"use strict";var i,o="deps-name",u="define",s="require",n="object",c="array",l="",f="script",p="$1",t=[],d=Object.prototype,h=t.push,g=t.slice,y=["String",Array,Function],e=location.pathname.replace(/[^\/]*$/,l),r=navigator.userAgent,m=r.replace(/.*webkit\/([\d]+).*/i,p)<=534,v=r.replace(/.*firefox\/([\d\.]+).*/i,p)<9;lt(r);var I,S=m||v,_=/^\w*\(\s*([^\),\s]+)(?:=>)?/,x=/[\D\d]*(?:at|@).*((?:http(?:s|)|file)\:(?:\:(?!\d)|[^\:])*)(?:\:\d*){1,}(?:\)|\r|\n|)$/i,E="#",T=a._Qma||{},R=T.v||l,k=[],A=[],M={},b={},w={},D=T.depends||{},$={};function L(t,e){return(e||document).getElementsByTagName(t)}w.requireIDs={},W($,T.alias),T.comp=function(t,e){return t.getAttribute(o)==(e=e.split(E)[0])||e==t.src},T.tmp={getAttribute:function(){return location.host}},T.getScriptByUri=function(t,e){for(var r,n=e.length;(r=e[--n])&&(i==r||!this.comp(r,t)););return r||this.tmp},w.moduleStorage={},w.toRealMI=function(t){return w.uri.real($[t]||t)},w.isInStorage=function(t){return w.moduleStorage[this.toRealMI(t)]},w.isInLoading=function(t){t=t.realMI();t=$[t.split(E)[0]]||t;var e=b[t];return!e&&(b[t]=t),e},w.cleanLoadingMark=function(t){delete b[t.realMI()]},w.pickMI=function(){return Q().getAttribute(o)},w.moduleIdRMap={},w.moduleId=function(t,e){return(this.moduleIdRMap[t]||(this.moduleIdRMap[t]=new RegExp(t+"(?:$|\\.js)","i"))).test(e)||(e=e+E+t),$[t]=(e||t).realMI()},w.isInModules=function(t){return M[t]},w.pull=function(t,e){var r,n=e.cmd&&_.test(t)&&(r=RegExp.$1)&&r!=s?"|"+RegExp.$1:l;return new RegExp("[^a-z](?:"+s+n+")\\s*\\(\\s*(?:'([^']+)'|\"([^\"]+)\")\\s*\\)","ig")},String.prototype.has=function(t){return H(t)&&(t=-1<this.indexOf(t)),P(t)&&(t=t.test(this)),t},String.prototype.realMI=function(){return w.toRealMI(this)};L(f);var O=L("head")[0];function N(t,e){this.id=t,this.exports=e,M[t]=e}function j(t,e){this.id=t,this.module=e,this.moduleID=e.id,this.wake()}function q(t,e){new N(t,e),e.id=t,new j("declare",e).done()}function F(e){if("string"!=typeof e)return function(t){return t instanceof e};var r=new RegExp("^\\[object "+e+"\\]$");return function(t){return r.test(d.toString.call(t))}}N.prototype.rebulid=function(){return M[this.id]=this.exports,this},W(j.prototype,{active:{},storage:w.moduleStorage,echo:pt,each:V,tools:new Y,data:function(){return this.module},wake:function(){return this.storage[this.moduleID]=this},stack:function(){return k.push(this),this},remove:function(){return this.id==s&&delete this.storage[this.moduleID],this},space:function(){return delete M[this.moduleID],this.remove()},depend:function(){var t=this.data();return t.alias in D&&h.apply(t.deps,(D[t.alias]||{}).deps||[]),U(t.factory)&&h.apply(t.deps,et.getDeps(t.factory)),t.deps||[]},isInActive:function(){return this.moduleID in this.active},run:function(){if(this.isDone())return this;var t=this.depend();return V(t,function(t,e){this[e.realMI()]=!0},this.active),lt("%c检索模块依赖 -> "+this.moduleID+" : ["+t+"] \r\n","color:#070"),h.apply(A,t),this.stack(),st(),this},done:function(){return this.loaded=!0,this},isDone:function(){return this.loaded},isInStorage:function(){return this.moduleID in this.storage},isReady:function(){for(var t,e=this.data().deps,r=e.length;t=e[--r];)if(!w.isInStorage(t))return lt("%c所依赖的模块["+t+"] [未加载完成]","color:#777"),!1;return!0},require:ot});var B=F("Object"),U=F("Function"),C=F("Array"),H=F("String"),P=F(RegExp),G=F(j),X=F("(?:Number|Boolean|Null|String|Undefined)"),J=function(t){return t&&B(t)},z=F("(?:(?!Array)|String)");function Q(){if(document.currentScript)return document.currentScript;var e,t,r,n,i=L(f);try{___I__Will__Error_____()}catch(t){e=(n=t).stack}if(e&&(e=e.replace(x,p),r=T.getScriptByUri(e,i)))return r;for(t=0;r=i[t++];)if("interactive"===r.readyState)return r;return T.getScriptByUri(T.currentLoad||n.sourceURL,i)}function W(t,e,r,n){var i,o,a,s,u;for(o=(u=g.call(arguments)).pop(),u.push(o),/false|true/gi.test(o)||u.push(!1),o=u.pop(),a=u.pop();s=u.shift();)for(i in a)!o&&s.hasOwnProperty&&s.hasOwnProperty(i)||(s[i]=a[i])}function K(t,e,r){r=r||this;for(var n=t.split("."),i=0;t=n[i++];)if(t in r){if(r=r[t],X(r)){lt("%c"+t+" 's type not Object! need Object {} ","color:red");break}}else r=r[t]={};return W(r,e),r}function V(t,e,r){U(e)&&w.factory[C(t)?c:n].call(r,t,e)}function Y(){}K("alias",{},T),K("suffixs",{},T),K("pick",{},T),w.factory={array:function(t,e,r,n){for(r=0,n=t.length>>0;r<n&&!e.call(this,r,t[r],t);r++);},object:function(t,e,r){for(r in t)if(e.call(this,r,t[r],t))break},push:function(t,e,r){return t.push(r)},add:function(t,e,r){t[e]=r}};var Z,tt,et=new Y,rt={SEP:"{@}",START:"{%}",LEFT:"{",RIGHT:"}",map:{},NUM:1e6,_has_async_func_:/(?:require|\w+)\s*\([^),]*/,_async_fx__:/(?:((?:require|\w+)\s*\([^),]*,[^(]*\([^)]*\)\s*(?:=>)?\s*\{)|(\{)|(\}))/g,REPLACE:function(t){return this.map[t]||(this.map[t]=new RegExp("\\"+this.START+t+"(?:(?!\\"+this.SEP+t+").|\\n)*\\"+this.SEP+t))}};function nt(t,e,r){r||(r=t);var n,i=(n=t.type,document.createElement(n));V(t.attr,function(t,e){this.setAttribute(t,e)},i),this.argument=[i,e,r],this.onload(t.isScript).onerror(i),O.appendChild(i),lt("%c正在加载模块 -> "+t.uri,"color:#e0e")}function it(t){var e;if(t=w.toRealMI(t),e=w.isInModules(t))return e;if(e=w.isInStorage(t)){var r,n=new N(t,{}),i=e.data();return lt("%c正在创建模块 : "+t,"color:blue"),r=i.length?w.factory.require(e):i.factory.apply(e,[ot,n.exports,n,t]),U(r)?n.exports=r:W(n.exports,r),n.rebulid(),e.done(),n.exports}}function ot(t,e){return z(t)&&void 0===e?it(t):(U(t)&&(e=t,t=[]),ot.async(t,e))}function at(t,e,r){var n,i=H(this)?this+l:w.pickMI(),o=0;if(J(t)||J(e)&&++o)return o||(e=t,t=i),t=w.moduleId(t,i),new j(u,new N(t,e)).done();var a=et.checkByType(y,[t,e,r],[i,[],function(){}]);t=a[0],e=a[1],(r=a[2]).cmd=!e.length;var s=w.moduleId(t,i);(n=w.isInStorage(s))||(n=new j(u,{id:s,deps:e,factory:r,length:e.length,alias:t})),n.isInActive()&&n.run()}function st(t){!function t(e,r){if(T.isSimplyLoad)return;if(!e.length)return lt("%c依赖列队加载完毕","color:#3e3"),et.runFx(r);var n,i=e.shift();lt("%c准备加载模块 -> "+i,"color:#666");if(n=w.isInStorage(i))n.run();else{if(w.isInLoading(i))return lt("%c已在加载列表 -> "+i,"color:#e06");var o=w.uri.get(i);T.currentLoad=o.uri,S&&(T.isSimplyLoad=!0),new nt(o,function(t){if(lt("该标签 : ",t.type,".sheet = ",!!this.argument[0].sheet," : ",t.uri,"color:red"),t.isScript){var e=this.argument[0];e.parentNode.removeChild(e)}T.isSimplyLoad=!1;var r=t.uri;if(r in D){var n=D[r]||[],i=n.exports;i&&at.call(r,n.deps,function(){return a[i]})}!w.isInStorage(r)&&at.call(r,{}),st()})}t(e,r)}(t||A,function(){for(var t,e=[],r={};t=k.pop();)if(G(t)&&!t.isDone()&&t.isInStorage()&&!(t.module.factory in r))if(r[t.module.factory]=0,t.isReady())et.runFx(w.factory[t.id],t),t.done();else if(e.push(t),t.id==u)break;h.apply(k,e)})}function ut(){I&&ot.async(I)}if(W(Y.prototype,{ANNOTATION_REG:/(?:(\/\*+(?:[^*]|\*[^\/])*\*\/))|(?:([^\/'":])\/\/.*$)[\r\n]*/gm,runFx:function(t,e){var r=g.call(arguments),n=r.shift();if(n instanceof Function)return n.apply(this,r)},getDeps:function(t){var e=t.toString();e=e.replace(this.ANNOTATION_REG,l),rt._has_async_func_.test(e)&&(e=this.removeAsyncRequire(e));var r={mark:w.pull(e,t),pick:[],map:w.requireIDs};return V(e.match(r.mark)||[],function(t,e){(e=e.replace(this.mark,"$1$2"))in this.map||(this.map[e]=!0,this.pick.push(e))},r),r.pick},removeAsyncRequire:function(t){var r=rt.LEFT,n=rt.RIGHT,i=rt.SEP,o=rt.START,a=!1,s=0,u=rt.NUM;for(t=t.replace(rt._async_fx__,function(t,e){return e?(u=1,s++,a=!0,o):a&&(t==r&&u++,t==n&&u--,0==u)?(a=!1,u=rt.NUM,i):l});-1!=t.indexOf(o)&&s--;)t=t.replace(rt.REPLACE(l),l);return t},checkByType:function(t,e,r){if(!C(e))return i;r||(r=[]);for(var n,i=[],o=0,a=t.length;(n=e.shift())||o<a;)F(t[o])(n)?i.push(n):(n&&e.unshift(n),i.push(r[o])),o++;return i},pick:function(r,t,e){if(!C(t))return r;var n=e||{};return V(t,function(t,e){e in r&&this.fx(this.box,e,r[e])},{box:n,fx:w.factory[C(e)?"push":"add"]}),n},toArray:function(t){return g.call(t)},merge:W}),i=Q(),et.config={JS:".js",CSS:".css",".js":f,".css":"link",data:{link:{type:"text/css",rel:"stylesheet"}},src:{link:"href",script:"src"},info:function(t){return lt("%cError: at ["+t+"] Modules do not exist or load timed out!")}},W(nt.prototype,{onload:function(t){return this[S&&!t?"load":"moduleLoad"].apply(this,this.argument),this},onerror:function(e){var r=this;return e.onerror=function(){r.task&&r.task.space();var t=r.argument[2];w.cleanLoadingMark(t.uri),et.runFx(ot.error||at.error||et.config.info,t),e.parentNode.removeChild(e)},this},load:function(e,r,n){var i=0,o=this;lt("进入低版本样式加载模式 > ",e.href,"color:#9bd807");!function t(){if(e.sheet||15e3<i)return r.call(o,n);i+=100,setTimeout(t,100)}()},moduleLoad:"onreadystatechange"in i?function(t,e,r){var n=this;t.onreadystatechange=function(t){/^(?:complete|loaded)$/.test(this.readyState)&&et.runFx.call(n,e,r)}}:function(t,e,r){var n=this;t.onload=function(t){et.runFx.call(n,e,r)}}}),ot.use=ot.async=function(t,e){H(t)&&(t=[t.realMI()]);var r=t.length,n=new j(s,{id:H(this)?this:s+ +new Date,deps:t,length:r,factory:e});for(U(e)&&(e.cmd=!1),n.async=!!r;r--&&w.isInModules(t[r]););r<0?w.factory.require(n):n.run()},K("factory",{require:function(t){var e=t.data(),r=e.deps.slice(0,e.length);return V(r,function(t,e){this[t]=it(e)},r),r.unshift(e.factory),et.runFx.apply(t.remove(),r)}},w),K("uri",{DOT_EXTNAME:/\.(js(?=$|#))/,HAS_EXT:/(?:(\.(?:css|js))|(.))(\?|\#|$)/,DOT:/(?:[^\/]*\/[^\/]*\.{2}\/|\/\.(?!\.))/,get:function(t){T.suffixs[t]||(t=t.split(E)[0]);var e=this.extname(t).toLowerCase(),r=this.path(/^(?:http[s]?|file)\:/.test(t)?t:t.realMI(),e),n={uri:t,type:et.config[e]||f,attr:{async:!0},suffix:e||l};return n.isScript=n.type==f,n.attr[o]=n.uri,n.attr[et.config.src[n.type]]=r,W(n.attr,et.config.data[n.type]),n},real:function(t){if(this.DOT.test(t))for(t=e+t;this.DOT.test(t);)t=t.replace(this.DOT,l);return t.replace(this.DOT_EXTNAME,l)},extname:function(t){var e=w.toRealMI(t),r=T.suffixs[t];return void 0===r&&(this.HAS_EXT.test(e),r=RegExp.$1 in et.config?RegExp.$1:et.config.JS),lt(e,">",this.HAS_EXT.test(e)," : |",r,"|","color:#07afd8"),r},path:function(t,e){var r=/\?|#/.test(t)?"&":"?";return(t=t.replace(this.HAS_EXT,"$2"+e+"$3"))+(R&&r+R)||l}},w),W(a,{declare:at,$define:at,define:at,require:ot,$require:ot,modules:M,$modules:M,assert:K},!1),q(s,ot),q("_tools__",et.pick(et,["runFx","checkByType","pick"])),at.toString=ot.toString=function(){return"function(){[native code]}"},I=i.getAttribute("main"),i.innerHTML){var ct="__runjs.inner__";at.call(ct,new Function("require","exports","module","__module_name",i.innerHTML)),ot(ct,function(){ut(),st()})}else ut();function lt(){a.DEBUG&&pt.apply(a,t.slice.call(arguments))}function ft(){var t=g.call(arguments).join("");Z||((Z=document.createElement("div")).id="debugBox",document.body.appendChild(Z)),tt||(tt=/(?:^\%c|color\:(.*)$)/g);var e=document.createElement("div"),r=t.replace(tt,l);r!=t&&(e.style.color=RegExp.$1),e.innerHTML=r,Z.appendChild(e),e.setAttribute("debug","true"),Z.scrollTop+=e.offsetHeight+10}function pt(){try{var t=Array.apply(null,arguments);console.log.apply(console,t)}catch(t){try{ft(g.call(arguments).join("\r\n\r\n"))}catch(t){}}}a.DEBUG=a.DEBUG||!1,a.appendChild=ft}(window);